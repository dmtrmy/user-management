<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="icon" href="/favicon.png" type="image/x-icon">
</head>
<body>
    <!-- This section shows if the user is not logged in -->
    <div id="loginRequired" style="display: none;">
        <h3>You need to log in to access the admin area.</h3>
        <a href="/login.html">Go to Login</a>
    </div>

    <!-- This section shows the admin dashboard if the user is logged in and authorized -->
    <div id="dashboardDiv" style="display: none;">
        <h1>Admin Dashboard</h1>
        <!-- Logout Button -->
        <button id="logoutBtn" onclick="logOut()">Logout</button>
        <table id="userTable">
            <thead>
                <tr>
                    <th>UUID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Street</th>
                    <th>House Number</th>
                    <th>Postal Code</th>
                    <th>City</th>
                    <th>Date Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Loading the Supabase script -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase client (replace these with your actual project URL and key)
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://ovdbjdhxpznokaggshep.supabase.co',  // Replace with your Supabase URL
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92ZGJqZGh4cHpub2thZ2dzaGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1MDU4MTUsImV4cCI6MjA1MTA4MTgxNX0.mJMmxNqKPC0XhaSQy96hRLp0Ed4qbdm7LcOvDph2YCA'  // Replace with your Supabase API Key
        );

        // Check if the user is logged in and has the correct email
        async function checkAuth() {
            const { data: { user }, error } = await supabaseClient.auth.getUser();

            if (user) {
                // Check if the user's email is in the allowed list
                const allowedEmails = ['dmtr.my@gmail.com']; // Add the admin email(s) you want to allow
                if (allowedEmails.includes(user.email)) {
                    document.getElementById('dashboardDiv').style.display = 'block';
                    fetchUsers();
                } else {
                    alert('You are not authorized to access this admin area.');
                    window.location.href = '/login.html';  // Redirect to login page
                }
            } else {
                document.getElementById('loginRequired').style.display = 'block';
            }
        }

        // Fetch and populate the user table
        async function fetchUsers() {
            try {
                const response = await fetch('/users');  // Replace with your backend endpoint
                const users = await response.json();
                const tableBody = document.querySelector('#userTable tbody');
                tableBody.innerHTML = '';  // Clear existing rows

                users.forEach(user => {
                    const row = `
                        <tr>
                            <td>${user.uuid}</td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.street || 'N/A'}</td>
                            <td>${user.house_number || 'N/A'}</td>
                            <td>${user.postal_code || 'N/A'}</td>
                            <td>${user.city || 'N/A'}</td>
                            <td>${user.created_at}</td>
                            <td>
                                <button onclick="editUser('${user.uuid}', '${user.name}', '${user.email}', '${user.street}', '${user.house_number}', '${user.postal_code}', '${user.city}')">Edit</button>
                                <button onclick="deleteUser('${user.uuid}')">Delete</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching users:', error);
            }
        }

        // Function to log out the user
        async function logOut() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error('Error signing out:', error.message);
            }
            window.location.href = '/login.html';  // Redirect to login page after logout
        }

        // Call the checkAuth function when the page loads
        checkAuth();
    </script>
</body>
</html>